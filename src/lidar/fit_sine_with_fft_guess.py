import numpy as np
from scipy.optimize import curve_fit
import matplotlib.pyplot as plt
from scipy.interpolate import interp1d


def mean_absolute_deviation(data):
    """
    This measure, the Mean Absolute Deviation, gives a clear idea of the variability or
    spread of the dataset around its central point, the mean.
     """
    # Convert input to a numpy array if it's not already one
    data = np.array(data)
    # Step 1: Calculate the mean
    data_mean = np.mean(data)
    # Step 2: Calculate the absolute deviations from the mean
    absolute_deviations = np.abs(data - data_mean)
    # Step 3: Calculate the mean of these absolute deviations
    mad = np.mean(absolute_deviations)
    return mad

def sine_function(t, amplitude, frequency, phase, offset):
    """Model function for the sine wave."""
    # Note: frequency here is in Hz (cycles per second), not angular frequency (radians per second)
    return amplitude * np.sin(2 * np.pi * frequency * t + phase) + offset


def fit_sine_with_fft_guess(t, theta):
    """
    Fits a sine curve to data using FFT to generate initial guesses
    for the parameters.
    """
    # 1. Estimate initial guesses from the data
    # Offset (mean of the data)
    guess_offset = np.mean(theta)
    # Amplitude (half of the peak-to-trough, or a common estimate is 2*std)
    guess_amplitude = 2 * np.std(theta)

    # Frequency (using FFT)
    # Assume uniform spacing
    dt = t[1] - t[0]
    # Get frequencies from FFT
    frequencies = np.fft.fftfreq(len(theta), dt)
    # Perform FFT
    yf = np.fft.fft(theta)
    # Exclude the zero frequency peak (offset) and take the absolute value
    # to find the frequency with the highest power
    max_power_index = np.argmax(np.abs(yf[1:len(t) // 2])) + 1
    guess_frequency = abs(frequencies[max_power_index])

    # Phase (can be guessed as 0, the curve_fit will optimize it)
    guess_phase = 0.0

    # Initial guess list for curve_fit: [amplitude, frequency, phase, offset]
    initial_guess = [guess_amplitude, guess_frequency, guess_phase, guess_offset]

    # print(f"Initial guesses: {initial_guess}")

    # 2. Perform the curve fitting using scipy.optimize.curve_fit
    try:
        # The bounds can help prevent the optimizer from getting lost in local minima
        # Example bounds: ([min_amp, min_freq, min_phase, min_offset],
        #                  [max_amp, max_freq, max_phase, max_offset])
        # For simplicity here, we use default bounds
        params, params_covariance = curve_fit(sine_function, t, theta, p0=initial_guess)
        return params

    except RuntimeError as e:
        print(f"Error during curve fitting: {e}")
        return None

def pendulum_equation(data):
    t0 = data[0][0]
    t_nonuniform = np.array([x[0]-t0 for x in data])
    theta_nonuniform = np.array([x[1] for x in data])

    # must be made uniform for curve fitting....
    t_uniform = np.linspace(t_nonuniform.min(), t_nonuniform.max(), len(data))
    interp_func = interp1d(t_nonuniform, theta_nonuniform, kind='linear')
    theta_uniform = interp_func(t_uniform)

    # 2. Fit the data
    fitted_params = fit_sine_with_fft_guess(t_uniform, theta_uniform)

    period = 0
    if fitted_params is not None:
        period = 1 / fitted_params[1] # sec/cycle

    return period, t_uniform, theta_uniform, fitted_params

# LiDAR Data Conversion: Ensure the 2D LiDAR points are converted to linear Cartesian
# coordinates to calculate the arc length or tangential distance the pendulum swings.

if __name__ == '__main__':
    from analyze_clock_rate import analyze_clock_rate
    # Non-uniform source data....
    # [ (time in sec, movement left to right in mm, movement back to front in mm) ... ]
    find_pendulum_thread_data =  [(78786.678293111, -102.0670090027505, 304.41826953056676), (78786.760564564, -111.16071392463468, 304.28568366259697), (78786.841830848, -123.09954263230419, 303.27535518922394), (78786.922408624, -130.33531462827065, 303.9484823522918), (78787.004038401, -135.90597712255595, 301.57496799876606), (78787.084294712, -145.4051229470017, 302.9647491551349), (78787.164825753, -148.4464075738925, 301.8418154694722), (78787.245809519, -146.52580207633684, 299.7625561266692), (78787.325854489, -148.44633510095628, 298.8881216177419), (78787.406231638, -148.60781876149738, 301.87999703422446), (78787.486232915, -138.10652958926653, 299.9853301136153), (78787.567244051, -137.32826416741233, 301.2043387025831), (78787.646347578, -130.1158712301612, 303.1558116060123), (78787.727096495, -122.90250291642133, 302.4044688727374), (78787.806452937, -111.82529173694701, 303.840124825955), (78787.886621889, -108.73222470468629, 305.44370412772736), (78787.966305503, -99.55433103098188, 305.7469473274403), (78788.046903052, -85.43349624191139, 305.9709704278945), (78788.127258433, -82.12329755350798, 306.2155875086306), (78788.206042171, -80.9198469244333, 306.41643668385797), (78788.287294048, -83.80889819175782, 306.59259032992713), (78788.367189038, -80.60512517074781, 306.25637209027104), (78788.446428449, -81.5945823081858, 306.55743411417797), (78788.526897596, -91.82141016619887, 305.91911794649246), (78788.60710181, -97.50494271592258, 305.72898095959766), (78788.686171291, -107.89749470125219, 305.6121195461697), (78788.766129729, -112.49452567966034, 302.8741849839963), (78788.845964854, -122.01521090783773, 302.8060875063088), (78788.92660272, -129.55134281095775, 301.92874479348296), (78789.006035222, -139.39987053998428, 302.57107283793414), (78789.08584668, -146.75946950206267, 300.25272641564504), (78789.165929475, -145.10685062712963, 300.4025651926824), (78789.245424325, -145.50911118852287, 302.02954245968647), (78789.325538568, -154.4701550555932, 301.4532744441133), (78789.485126356, -140.0979537670418, 299.1959984301057), (78789.565130741, -143.89237542246605, 303.12411858409155), (78789.64508353, -128.36116138637607, 301.00358299048247), (78789.72427622, -123.15191758548117, 303.4363375909351), (78789.804495933, -109.06809003573122, 303.3503508428549), (78789.884133742, -105.3982425398625, 304.05235903611657), (78789.963263971, -95.7837756306037, 304.01941219050485), (78790.044435046, -88.45558203830672, 305.2185628102644), (78790.122857137, -83.84119960847936, 306.53679656080254), (78790.203503725, -77.36010150096449, 306.9844395440725), (78790.28299653, -80.87955328327187, 306.4379613082004), (78790.362453837, -82.46492835245972, 307.7121757746023), (78790.442144018, -82.44017359739351, 307.40923852312335), (78790.522301628, -89.7410681971712, 306.20159302125177), (78790.602033231, -99.64492750700327, 307.1425915333953), (78790.681691632, -107.65272629896278, 305.90368842530046), (78790.761382276, -113.78833223811526, 304.5318981947483), (78790.841803323, -116.50212759206553, 302.32246290764897), (78790.920271203, -126.21477239597417, 302.0556300420787), (78791.000172896, -137.8034564757866, 303.1813716413602), (78791.079825607, -137.8214118950536, 301.6188908238077), (78791.159671445, -149.76593119677153, 302.80528967359123), (78791.240360549, -152.2913396286698, 300.75609736341056), (78791.319692665, -145.15349839681642, 299.30226405714507), (78791.39911205, -148.83025897114277, 302.78374367865445), (78791.479613348, -143.30326246348278, 302.18218877781146), (78791.558956332, -139.74962948973123, 301.8081806077127), (78791.638350546, -135.9332434475221, 305.54872395797486), (78791.718779741, -122.94303601008433, 302.1080135603201), (78791.798736344, -114.68895324655323, 304.4363081302943), (78791.87751148, -102.56873018294593, 303.2565301107136), (78791.958114758, -98.73019973616256, 306.38398424301175), (78792.037593199, -88.7642261538772, 305.7843170116762), (78792.116694542, -84.46302940379015, 305.705396877352), (78792.197212601, -75.87420166220616, 306.00988576774205), (78792.276955764, -82.18760710523351, 306.67589020077213), (78792.43651188, -78.62985238842003, 307.3247535682819), (78792.516123127, -90.76415371597419, 306.1140826036561), (78792.595824076, -93.9350278500102, 305.24279694045185), (78792.674829903, -104.9418037511194, 305.2349941424444), (78792.755020236, -109.15534107138119, 303.49110650318136), (78792.834286473, -120.08583228231942, 303.04637126403804), (78792.914477711, -132.2627629318966, 303.83612242480945), (78792.993988416, -135.3865256097581, 301.68128130137006), (78793.073284764, -139.77143733885958, 300.5950238130938), (78793.153034954, -145.38891846405824, 301.01081383081583), (78793.232759342, -149.52141333325528, 300.4335173905678), (78793.312170863, -146.93643991040676, 300.02729841674943), (78793.392036001, -151.64984868697024, 303.0055682519948), (78793.4719745, -144.3698297683813, 301.086835542055), (78793.551950975, -144.25220278668937, 301.21322619245126), (78793.632016952, -130.91900751772272, 302.6895624311949), (78793.711290417, -121.40039240678558, 302.1733233153821), (78793.791082285, -118.97028606662514, 304.4830742035103), (78793.870498937, -108.23565755751946, 305.1264265799461), (78793.950175689, -95.73794144286346, 305.65701280400384), (78794.030089428, -93.88311613361017, 306.66644833017887), (78794.110466757, -85.03172118022265, 306.97290176946433), (78794.189407316, -80.60793596208914, 307.53210910807326), (78794.269421421, -81.99467845005691, 306.09346236869135), (78794.348335599, -79.95662896072947, 306.2453133236975), (78794.428790774, -84.45870488760391, 307.35231043957754), (78794.507672123, -90.80123412022769, 307.20280418733654), (78794.587735753, -92.30636623793575, 306.6521869189678), (78794.666757003, -103.40432124836029, 304.7932606678965), (78794.747091344, -105.65309170212473, 302.56067224071455), (78794.826588676, -115.84791967718073, 302.0672057452078), (78794.90634733, -129.06824601086308, 302.05005327614225), (78794.986464579, -136.5343788514946, 300.99251125273685), (78795.06574591, -141.11773911206498, 304.21067383233776), (78795.145745734, -146.32526988815124, 301.2370854495373), (78795.22556415, -150.792761871849, 300.63904583648275), (78795.304384619, -147.1260454671333, 300.31169193155745), (78795.464518239, -143.34694383000968, 299.9389597581865), (78795.543807554, -140.6047116734463, 300.21857364387876), (78795.623263256, -130.57727577110603, 302.5021456271728), (78795.702599629, -124.42070547534934, 303.793159094195), (78795.782510559, -117.17336836689066, 303.3922135793461), (78795.862536691, -109.99408059058919, 304.92582325381653), (78795.941761128, -99.37227085798462, 304.9337610389731), (78796.021699394, -93.29790867223461, 306.147217021744), (78796.101747276, -83.89490027830337, 305.0231264458201), (78796.181159795, -81.0907205034606, 306.7625554769814), (78796.260881074, -77.54313013227592, 306.59476603011495), (78796.340872374, -75.17847485070469, 305.89994352886123), (78796.499538934, -85.9366638217648, 307.42451423040234), (78796.57946893, -90.74290263290331, 305.57365278046416), (78796.659020735, -103.48061226226923, 305.8548263123121), (78796.73886467, -112.34903346276919, 305.58690288909315), (78796.81823014, -117.07690591235745, 303.9126128979241), (78796.897791735, -126.13154274178966, 304.2036540640302), (78796.977333948, -133.74860367487787, 300.9711843569558), (78797.056712015, -137.28493069550962, 300.56643937972433), (78797.137076442, -141.8336252555523, 300.04996211800375), (78797.217053882, -146.909030376624, 300.4278770440721), (78797.29541346, -152.78990328742773, 301.6147402594257)]
    period, t_uniform, theta_uniform, fitted_params = pendulum_equation(find_pendulum_thread_data)

    if fitted_params is not None:
        print(f"Fitted parameters: {fitted_params}")
        # A large number here shows the extent to which the pendulum and LIDAR are not in alignment...
        print(f"Mean deviation back to front (mm) {mean_absolute_deviation([x[2] for x in find_pendulum_thread_data])}")
        print(f"Mean deviation left to right (mm) {mean_absolute_deviation([x[1] for x in find_pendulum_thread_data])}")
        print(f"Pendulum Period: {period} (sec/cycle)")
        error, behavior = analyze_clock_rate(period)
        print(f"Day Error: {behavior} {error:.2f} (sec/day).")
        print(f"Pendulum Swing (mm): {abs(min(theta_uniform) - max(theta_uniform))}")
        theta_uniform_computed = sine_function(t_uniform, *fitted_params)
        print(f"Pendulum Swing Computed (mm): {abs(min(theta_uniform_computed) - max(theta_uniform_computed))}")

        print("Plot the results...")
        plt.figure(figsize=(10, 6))
        plt.scatter(t_uniform, theta_uniform, label='Original Data (position vs time)', alpha=0.5)
        plt.plot(t_uniform, theta_uniform_computed, label='Fitted Curve', color='red')
        plt.title('Sine Curve Fit to Data using FFT for Initial Guess')
        plt.xlabel('Time (s)')
        plt.ylabel('LIDAR Radian to Cartesian Position (mm)')
        plt.legend()
        plt.grid(True)
        plt.show()
